name: æ›´æ–°å¿…åº”å£çº¸

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 17:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 1:00ï¼‰
    - cron: "0 17 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]
    # åªå¯¹ç‰¹å®šæ–‡ä»¶å˜æ›´è§¦å‘ï¼Œé¿å…ä¸ Pages å†²çª
    paths-ignore:
      - "archives/**"
      - "README.md"

# ä¿®æ”¹å¹¶å‘æ§åˆ¶ï¼Œåªæ§åˆ¶æœ¬å·¥ä½œæµçš„å¹¶å‘ï¼Œä¸ä¸ Pages å†²çª
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update-wallpaper:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è·å–å¿…åº”å£çº¸
        run: pnpm start

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        id: check_changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .

          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ–°"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å£çº¸æ›´æ–°"
          fi

      - name: æäº¤æ›´æ–°
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "ğŸ–¼ï¸ è‡ªåŠ¨æ›´æ–°å¿…åº”å£çº¸ $(date -d '+1 day' '+%Y-%m-%d')"
          git push

      - name: æ›´æ–°çŠ¶æ€
        run: |
          echo "âœ… å£çº¸æ›´æ–°ä»»åŠ¡å®Œæˆ"
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
